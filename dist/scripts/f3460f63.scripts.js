function X2JS(config){"use strict";function initConfigDefaults(){void 0===config.escapeMode&&(config.escapeMode=!0),config.attributePrefix=config.attributePrefix||"_",config.arrayAccessForm=config.arrayAccessForm||"none",config.emptyNodeForm=config.emptyNodeForm||"text",void 0===config.enableToStringFunc&&(config.enableToStringFunc=!0),config.arrayAccessFormPaths=config.arrayAccessFormPaths||[],void 0===config.skipEmptyTextNodesForObj&&(config.skipEmptyTextNodesForObj=!0),void 0===config.stripWhitespaces&&(config.stripWhitespaces=!0),config.datetimeAccessFormPaths=config.datetimeAccessFormPaths||[]}function initRequiredPolyfills(){function pad(number){var r=String(number);return 1===r.length&&(r="0"+r),r}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|^\n+|(\s|\n)+$/g,"")}),"function"!=typeof Date.prototype.toISOString&&(Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"})}function getNodeLocalName(node){var nodeLocalName=node.localName;return null==nodeLocalName&&(nodeLocalName=node.baseName),(null==nodeLocalName||""==nodeLocalName)&&(nodeLocalName=node.nodeName),nodeLocalName}function getNodePrefix(node){return node.prefix}function escapeXmlChars(str){return"string"==typeof str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):str}function unescapeXmlChars(str){return str.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function toArrayAccessForm(obj,childName,path){switch(config.arrayAccessForm){case"property":obj[childName+"_asArray"]=obj[childName]instanceof Array?obj[childName]:[obj[childName]]}if(!(obj[childName]instanceof Array)&&config.arrayAccessFormPaths.length>0){for(var idx=0;idx<config.arrayAccessFormPaths.length;idx++){var arrayPath=config.arrayAccessFormPaths[idx];if("string"==typeof arrayPath){if(arrayPath==path)break}else if(arrayPath instanceof RegExp){if(arrayPath.test(path))break}else if("function"==typeof arrayPath&&arrayPath(obj,childName,path))break}idx!=config.arrayAccessFormPaths.length&&(obj[childName]=[obj[childName]])}}function fromXmlDateTime(prop){var bits=prop.split(/[-T:+Z]/g),d=new Date(bits[0],bits[1]-1,bits[2]),secondBits=bits[5].split(".");if(d.setHours(bits[3],bits[4],secondBits[0]),secondBits.length>1&&d.setMilliseconds(secondBits[1]),bits[6]&&bits[7]){var offsetMinutes=60*bits[6]+Number(bits[7]),sign=/\d\d-\d\d:\d\d$/.test(prop)?"-":"+";offsetMinutes=0+("-"==sign?-1*offsetMinutes:offsetMinutes),d.setMinutes(d.getMinutes()-offsetMinutes-d.getTimezoneOffset())}else-1!==prop.indexOf("Z",prop.length-1)&&(d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds())));return d}function checkFromXmlDateTimePaths(value,childName,fullPath){if(config.datetimeAccessFormPaths.length>0){for(var path=fullPath.split(".#")[0],idx=0;idx<config.datetimeAccessFormPaths.length;idx++){var dtPath=config.datetimeAccessFormPaths[idx];if("string"==typeof dtPath){if(dtPath==path)break}else if(dtPath instanceof RegExp){if(dtPath.test(path))break}else if("function"==typeof dtPath&&dtPath(obj,childName,path))break}return idx!=config.datetimeAccessFormPaths.length?fromXmlDateTime(value):value}return value}function parseDOMChildren(node,path){if(node.nodeType==DOMNodeTypes.DOCUMENT_NODE){for(var result=new Object,nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx);if(child.nodeType==DOMNodeTypes.ELEMENT_NODE){var childName=getNodeLocalName(child);result[childName]=parseDOMChildren(child,childName)}}return result}if(node.nodeType==DOMNodeTypes.ELEMENT_NODE){var result=new Object;result.__cnt=0;for(var nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx),childName=getNodeLocalName(child);child.nodeType!=DOMNodeTypes.COMMENT_NODE&&(result.__cnt++,null==result[childName]?(result[childName]=parseDOMChildren(child,path+"."+childName),toArrayAccessForm(result,childName,path+"."+childName)):(null!=result[childName]&&(result[childName]instanceof Array||(result[childName]=[result[childName]],toArrayAccessForm(result,childName,path+"."+childName))),result[childName][result[childName].length]=parseDOMChildren(child,path+"."+childName)))}for(var aidx=0;aidx<node.attributes.length;aidx++){var attr=node.attributes.item(aidx);result.__cnt++,result[config.attributePrefix+attr.name]=attr.value}var nodePrefix=getNodePrefix(node);return null!=nodePrefix&&""!=nodePrefix&&(result.__cnt++,result.__prefix=nodePrefix),null!=result["#text"]&&(result.__text=result["#text"],result.__text instanceof Array&&(result.__text=result.__text.join("\n")),config.escapeMode&&(result.__text=unescapeXmlChars(result.__text)),config.stripWhitespaces&&(result.__text=result.__text.trim()),delete result["#text"],"property"==config.arrayAccessForm&&delete result["#text_asArray"],result.__text=checkFromXmlDateTimePaths(result.__text,childName,path+"."+childName)),null!=result["#cdata-section"]&&(result.__cdata=result["#cdata-section"],delete result["#cdata-section"],"property"==config.arrayAccessForm&&delete result["#cdata-section_asArray"]),1==result.__cnt&&null!=result.__text?result=result.__text:0==result.__cnt&&"text"==config.emptyNodeForm?result="":result.__cnt>1&&null!=result.__text&&config.skipEmptyTextNodesForObj&&(config.stripWhitespaces&&""==result.__text||""==result.__text.trim())&&delete result.__text,delete result.__cnt,!config.enableToStringFunc||null==result.__text&&null==result.__cdata||(result.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),result}return node.nodeType==DOMNodeTypes.TEXT_NODE||node.nodeType==DOMNodeTypes.CDATA_SECTION_NODE?node.nodeValue:void 0}function startTag(jsonObj,element,attrList,closed){var resultStr="<"+(null!=jsonObj&&null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+element;if(null!=attrList)for(var aidx=0;aidx<attrList.length;aidx++){var attrName=attrList[aidx],attrVal=jsonObj[attrName];config.escapeMode&&(attrVal=escapeXmlChars(attrVal)),resultStr+=" "+attrName.substr(config.attributePrefix.length)+"='"+attrVal+"'"}return resultStr+=closed?"/>":">"}function endTag(jsonObj,elementName){return"</"+(null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+elementName+">"}function endsWith(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)}function jsonXmlSpecialElem(jsonObj,jsonObjField){return"property"==config.arrayAccessForm&&endsWith(jsonObjField.toString(),"_asArray")||0==jsonObjField.toString().indexOf(config.attributePrefix)||0==jsonObjField.toString().indexOf("__")||jsonObj[jsonObjField]instanceof Function?!0:!1}function jsonXmlElemCount(jsonObj){var elementsCnt=0;if(jsonObj instanceof Object)for(var it in jsonObj)jsonXmlSpecialElem(jsonObj,it)||elementsCnt++;return elementsCnt}function parseJSONAttributes(jsonObj){var attrList=[];if(jsonObj instanceof Object)for(var ait in jsonObj)-1==ait.toString().indexOf("__")&&0==ait.toString().indexOf(config.attributePrefix)&&attrList.push(ait);return attrList}function parseJSONTextAttrs(jsonTxtObj){var result="";return null!=jsonTxtObj.__cdata&&(result+="<![CDATA["+jsonTxtObj.__cdata+"]]>"),null!=jsonTxtObj.__text&&(result+=config.escapeMode?escapeXmlChars(jsonTxtObj.__text):jsonTxtObj.__text),result}function parseJSONTextObject(jsonTxtObj){var result="";return jsonTxtObj instanceof Object?result+=parseJSONTextAttrs(jsonTxtObj):null!=jsonTxtObj&&(result+=config.escapeMode?escapeXmlChars(jsonTxtObj):jsonTxtObj),result}function parseJSONArray(jsonArrRoot,jsonArrObj,attrList){var result="";if(0==jsonArrRoot.length)result+=startTag(jsonArrRoot,jsonArrObj,attrList,!0);else for(var arIdx=0;arIdx<jsonArrRoot.length;arIdx++)result+=startTag(jsonArrRoot[arIdx],jsonArrObj,parseJSONAttributes(jsonArrRoot[arIdx]),!1),result+=parseJSONObject(jsonArrRoot[arIdx]),result+=endTag(jsonArrRoot[arIdx],jsonArrObj);return result}function parseJSONObject(jsonObj){var result="",elementsCnt=jsonXmlElemCount(jsonObj);if(elementsCnt>0)for(var it in jsonObj)if(!jsonXmlSpecialElem(jsonObj,it)){var subObj=jsonObj[it],attrList=parseJSONAttributes(subObj);if(null==subObj||void 0==subObj)result+=startTag(subObj,it,attrList,!0);else if(subObj instanceof Object)if(subObj instanceof Array)result+=parseJSONArray(subObj,it,attrList);else if(subObj instanceof Date)result+=startTag(subObj,it,attrList,!1),result+=subObj.toISOString(),result+=endTag(subObj,it);else{var subObjElementsCnt=jsonXmlElemCount(subObj);subObjElementsCnt>0||null!=subObj.__text||null!=subObj.__cdata?(result+=startTag(subObj,it,attrList,!1),result+=parseJSONObject(subObj),result+=endTag(subObj,it)):result+=startTag(subObj,it,attrList,!0)}else result+=startTag(subObj,it,attrList,!1),result+=parseJSONTextObject(subObj),result+=endTag(subObj,it)}return result+=parseJSONTextObject(jsonObj)}var VERSION="1.1.5";config=config||{},initConfigDefaults(),initRequiredPolyfills();var DOMNodeTypes={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(xmlDocStr){var isIEParser=window.ActiveXObject||"ActiveXObject"in window;if(void 0===xmlDocStr)return null;var xmlDoc;if(window.DOMParser){var parser=new window.DOMParser,parsererrorNS=null;if(!isIEParser)try{parsererrorNS=parser.parseFromString("INVALID","text/xml").childNodes[0].namespaceURI}catch(err){parsererrorNS=null}try{xmlDoc=parser.parseFromString(xmlDocStr,"text/xml"),null!=parsererrorNS&&xmlDoc.getElementsByTagNameNS(parsererrorNS,"parsererror").length>0&&(xmlDoc=null)}catch(err){xmlDoc=null}}else 0==xmlDocStr.indexOf("<?")&&(xmlDocStr=xmlDocStr.substr(xmlDocStr.indexOf("?>")+2)),xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(xmlDocStr);return xmlDoc},this.asArray=function(prop){return prop instanceof Array?prop:[prop]},this.toXmlDateTime=function(dt){return dt instanceof Date?dt.toISOString():"number"==typeof dt?new Date(dt).toISOString():null},this.asDateTime=function(prop){return"string"==typeof prop?fromXmlDateTime(prop):prop},this.xml2json=function(xmlDoc){return parseDOMChildren(xmlDoc)},this.xml_str2json=function(xmlDocStr){var xmlDoc=this.parseXmlString(xmlDocStr);return null!=xmlDoc?this.xml2json(xmlDoc):null},this.json2xml_str=function(jsonObj){return parseJSONObject(jsonObj)},this.json2xml=function(jsonObj){var xmlDocStr=this.json2xml_str(jsonObj);return this.parseXmlString(xmlDocStr)},this.getVersion=function(){return VERSION}}angular.module("config",[]).constant("AppURLs",{allStations:{url:"/channels.xml"},pls:{url:"/[STATION_ID].pls?popup",key:"[STATION_ID]"},playList:{url:"/songs/[STATION_ID].xml",key:"[STATION_ID]"},community:{sections:["news","flickr"]},news:{url:"/news.html"}}),angular.module("somafmPlayerApp",["ui.router","ngCookies","ngResource","ngSanitize","config","LocalStorageModule"]).constant("USE_HTML_AUDIO",function(){var elem=document.createElement("audio");if("function"==typeof elem.canPlayType){var playable=elem.canPlayType("audio/mpeg");if("maybe"==playable.toLowerCase()||"probably"==playable.toLowerCase())return!0}return!1}()).constant("POLL_INT",3e4).constant("SHOP_URI","http://macapi.somafm.com/buy/appbuy.cgi?mode=amazon&title={SONG}&artist={ARTIST}").config(["localStorageServiceProvider",function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("somafm")}]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("all-stations",{url:"/all-stations",templateUrl:"views/all-stations.html",controller:"AllStationsCtrl"}).state("fav-stations",{url:"/fav-stations",templateUrl:"views/fav-stations.html",controller:"FavStationsCtrl"}).state("fav-songs",{url:"/fav-songs",templateUrl:"views/fav-songs.html",controller:"FavSongsCtrl"}).state("community",{url:"/community",templateUrl:"views/community.html",controller:"CommunityCtrl"}).state("now-playing",{url:"/now-playing/:stationID",templateUrl:"views/now-playing.html",controller:"NowPlayingCtrl"}),$urlRouterProvider.otherwise("/all-stations")}),angular.module("somafmPlayerApp").factory("StationTransform",function(){return function(data){var x2js=new X2JS,xmlDoc=x2js.parseXmlString(data),json=x2js.xml2json(xmlDoc),parsedChannels=[],channels=json.channels.channel;return angular.forEach(channels,function(channel){var parsedChannel={};angular.forEach(channel,function(prop,key){parsedChannel[key]=prop.toString()}),parsedChannels.push(parsedChannel)}),parsedChannels}}).factory("PlsTransform",function(){return function(data){var entries={};angular.forEach(data.split("\n"),function(item){var entry=item.split("=");entry.length>1&&(entries[entry[0].toLowerCase()]=entry[1])});for(var count=entries.numberofentries,urls=[],i=1;count>=i;i++){var url=entries["file"+i];urls.push(url)}return urls}}).factory("PlaylistTransform",function(){return function(data){var x2js=new X2JS,json=x2js.xml_str2json(data),parsedSongs=[],songs=json.songs.song;return angular.forEach(songs,function(song){var parsedSong={};angular.forEach(song,function(prop,key){parsedSong[key]="date"===key?new Date(1e3*parseInt(prop)):prop.toString()}),parsedSongs.push(parsedSong)}),parsedSongs}});var angularLocalStorage=angular.module("LocalStorageModule",[]);angularLocalStorage.provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(prefix){this.prefix=prefix},this.setStorageType=function(storageType){this.storageType=storageType},this.setStorageCookie=function(exp,path){this.cookie={expiry:exp,path:path}},this.setStorageCookieDomain=function(domain){this.cookie.domain=domain},this.setNotify=function(itemSet,itemRemove){this.notify={setItem:itemSet,removeItem:itemRemove}},this.$get=["$rootScope","$window","$document",function($rootScope,$window,$document){var webStorage,prefix=this.prefix,cookie=this.cookie,notify=this.notify,storageType=this.storageType;$document||($document=document),"."!==prefix.substr(-1)&&(prefix=prefix?prefix+".":"");var deriveQualifiedKey=function(key){return prefix+key},browserSupportsLocalStorage=function(){try{var supported=storageType in $window&&null!==$window[storageType],key=deriveQualifiedKey("__"+Math.round(1e7*Math.random()));return supported&&(webStorage=$window[storageType],webStorage.setItem(key,""),webStorage.removeItem(key)),supported}catch(e){return storageType="cookie",$rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}}(),addToLocalStorage=function(key,value){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),notify.setItem&&$rootScope.$broadcast("LocalStorageModule.notification.setitem",{key:key,newvalue:value,storageType:"cookie"}),addToCookies(key,value);"undefined"==typeof value&&(value=null);try{(angular.isObject(value)||angular.isArray(value))&&(value=angular.toJson(value)),webStorage&&webStorage.setItem(deriveQualifiedKey(key),value),notify.setItem&&$rootScope.$broadcast("LocalStorageModule.notification.setitem",{key:key,newvalue:value,storageType:this.storageType})}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),addToCookies(key,value)}return!0},getFromLocalStorage=function(key){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),getFromCookies(key);var item=webStorage?webStorage.getItem(deriveQualifiedKey(key)):null;return item&&"null"!==item?"{"===item.charAt(0)||"["===item.charAt(0)?angular.fromJson(item):item:null},removeFromLocalStorage=function(key){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),notify.removeItem&&$rootScope.$broadcast("LocalStorageModule.notification.removeitem",{key:key,storageType:"cookie"}),removeFromCookies(key);try{webStorage.removeItem(deriveQualifiedKey(key)),notify.removeItem&&$rootScope.$broadcast("LocalStorageModule.notification.removeitem",{key:key,storageType:this.storageType})}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),removeFromCookies(key)}return!0},getKeysForLocalStorage=function(){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),!1;var prefixLength=prefix.length,keys=[];for(var key in webStorage)if(key.substr(0,prefixLength)===prefix)try{keys.push(key.substr(prefixLength))}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.Description),[]}return keys},clearAllFromLocalStorage=function(regularExpression){regularExpression=regularExpression||"";var tempPrefix=prefix.slice(0,-1),testRegex=new RegExp(tempPrefix+"."+regularExpression);if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),clearAllFromCookies();var prefixLength=prefix.length;for(var key in webStorage)if(testRegex.test(key))try{removeFromLocalStorage(key.substr(prefixLength))}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),clearAllFromCookies()}return!0},browserSupportsCookies=function(){try{return navigator.cookieEnabled||"cookie"in $document&&($document.cookie.length>0||($document.cookie="test").indexOf.call($document.cookie,"test")>-1)}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}},addToCookies=function(key,value){if("undefined"==typeof value)return!1;if(!browserSupportsCookies())return $rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var expiry="",expiryDate=new Date,cookieDomain="";if(null===value?(expiryDate.setTime(expiryDate.getTime()+-864e5),expiry="; expires="+expiryDate.toGMTString(),value=""):0!==cookie.expiry&&(expiryDate.setTime(expiryDate.getTime()+24*cookie.expiry*60*60*1e3),expiry="; expires="+expiryDate.toGMTString()),key){var cookiePath="; path="+cookie.path;cookie.domain&&(cookieDomain="; domain="+cookie.domain),$document.cookie=deriveQualifiedKey(key)+"="+encodeURIComponent(value)+expiry+cookiePath+cookieDomain}}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}return!0},getFromCookies=function(key){if(!browserSupportsCookies())return $rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var cookies=$document.cookie&&$document.cookie.split(";")||[],i=0;i<cookies.length;i++){for(var thisCookie=cookies[i];" "===thisCookie.charAt(0);)thisCookie=thisCookie.substring(1,thisCookie.length);if(0===thisCookie.indexOf(deriveQualifiedKey(key)+"="))return decodeURIComponent(thisCookie.substring(prefix.length+key.length+1,thisCookie.length))}return null},removeFromCookies=function(key){addToCookies(key,null)},clearAllFromCookies=function(){for(var thisCookie=null,prefixLength=prefix.length,cookies=$document.cookie.split(";"),i=0;i<cookies.length;i++){for(thisCookie=cookies[i];" "===thisCookie.charAt(0);)thisCookie=thisCookie.substring(1,thisCookie.length);var key=thisCookie.substring(prefixLength,thisCookie.indexOf("="));removeFromCookies(key)}},getStorageType=function(){return storageType},bindToScope=function(scope,key,def){var value=getFromLocalStorage(key);null===value&&angular.isDefined(def)?value=def:angular.isObject(value)&&angular.isObject(def)&&(value=angular.extend(def,value)),scope[key]=value,scope.$watchCollection(key,function(newVal){addToLocalStorage(key,newVal)})};return{isSupported:browserSupportsLocalStorage,getStorageType:getStorageType,set:addToLocalStorage,add:addToLocalStorage,get:getFromLocalStorage,keys:getKeysForLocalStorage,remove:removeFromLocalStorage,clearAll:clearAllFromLocalStorage,bind:bindToScope,deriveKey:deriveQualifiedKey,cookie:{set:addToCookies,add:addToCookies,get:getFromCookies,remove:removeFromCookies,clearAll:clearAllFromCookies}}}]}),angular.module("somafmPlayerApp").directive("viewstack",["$window","$timeout","$rootScope",function($window,$timeout,$rootScope){return{restrict:"E",replace:!0,scope:{},template:"<div id='viewstack' class='viewstack container'' ui-view onload='updateLayout()'></div>",link:function(scope){scope.updateLayout=function(){var view=angular.element(document.getElementById("viewstack")),winHeight=$window.innerHeight,footerHeight=document.getElementById("footer").clientHeight,newHeight=winHeight-footerHeight-10;view.css("height",newHeight+"px"),$rootScope.viewStackHeight=newHeight},angular.element($window).bind("resize",function(){scope.updateLayout()}),$timeout(function(){scope.updateLayout()},300)}}}]).directive("list",["$window","$timeout","$rootScope",function($window,$timeout,$rootScope){return{restrict:"E",replace:!0,scope:{},transclude:!0,template:"<div id='list' class='list' ng-transclude></div>",link:function(scope,element){scope.updateLayout=function(){for(var children=element.parent().children(),list=angular.element(document.getElementById("list")),availHeight=$rootScope.viewStackHeight,i=0;i<children.length;i++){var child=angular.element(children[i]);if("list"!=child.attr("id")){var mTop=Number(child.css("margin-top").replace("px",""))||0,mBtm=Number(child.css("margin-bottom").replace("px",""))||0,childHeight=parseInt(children[i].clientHeight);availHeight-=childHeight+mTop+mBtm}}list.css("height",availHeight+"px")},angular.element($window).bind("resize",function(){scope.updateLayout()}),$timeout(function(){scope.updateLayout()},300)}}}]).directive("audioplayer",["USE_HTML_AUDIO",function(USE_HTML_AUDIO){return{restrict:"E",replace:!0,require:"",scope:{station:"="},template:function(){var tmp;return tmp="<div class='control-bar'>",tmp+=USE_HTML_AUDIO?"<htmlplayer station='station' ></htmlplayer>":"<flashplayer width='570' height='54' ></flashplayer>",tmp+="</div>"}}}]).directive("htmlplayer",["$rootScope","$window","$timeout",function($rootScope,$window,$timeout){return{restrict:"E",replace:!0,scope:{station:"="},template:"<div class='player'><audio id='audioPlayer' autoplay='true' preload='none'></audio><button id='playBtn' class='btn btn-link btn-lg' ng-show='!playing' ng-disabled='!station' ng-click='togglePlay()'><span class='glyphicon glyphicon-play'></span></button><button id='pauseBtn' class='btn btn-link btn-lg' ng-show='playing' ng-disabled='!station' ng-click='togglePlay()'><span class='glyphicon glyphicon-pause'></span></button><button id='unmuteBtn' class='btn btn-link btn-lg' ng-show='!isMuted()' ng-click='toggleMute()'><span class='glyphicon glyphicon-volume-down'></span></button><button id='muteBtn' class='btn btn-link btn-lg' ng-show='isMuted()' ng-click='toggleMute()'><span class='glyphicon glyphicon-volume-off'></span></button><volumebar id='volumeslider' value='volume' min='0' max='1' value-change='updateVolume(val)'></volumebar><button id='maxvolBtn' class='btn btn-link btn-lg' ng-click='maxVolume()'><span class='glyphicon glyphicon-volume-up'></span></button></div>",link:function(scope,element){scope.muted=!1,scope.playing=!1,scope.audio=document.getElementById("audioPlayer"),scope.volume=scope.audio.volume,scope.$watch("station",function(val){scope.audio.pause(),angular.element(scope.audio).html(""),val?(angular.forEach(val.urls.reverse(),function(url){var source=document.createElement("source");scope.audio.canPlayType("audio/mpeg;")?(source.type="audio/mpeg",source.src=url):(source.type="audio/ogg",source.src=url),scope.audio.appendChild(source)}),scope.audio.load(),scope.audio.play(),scope.playing=!0):(scope.audio.load(),scope.playing=!1),$timeout(function(){window.dispatchEvent(new Event("resize"))},50)}),angular.element($window).bind("resize",function(){scope.updateLayout()}),scope.updateLayout=function(){var totalWidth=parseInt(element.css("width").replace("px",""));totalWidth-=parseInt(scope.playing?angular.element(document.getElementById("pauseBtn")).css("width").replace("px",""):angular.element(document.getElementById("playBtn")).css("width").replace("px","")),totalWidth-=parseInt(scope.isMuted()?angular.element(document.getElementById("muteBtn")).css("width").replace("px",""):angular.element(document.getElementById("unmuteBtn")).css("width").replace("px","")),totalWidth-=parseInt(angular.element(document.getElementById("maxvolBtn")).css("width").replace("px","")),totalWidth-=30,angular.element(document.getElementById("volumeslider")).css("width",Math.min(totalWidth,200)+"px")},scope.togglePlay=function(){scope.playing?(scope.audio.pause(),scope.playing=!1):(scope.audio.play(),scope.playing=!0)},scope.volumeDown=function(){scope.audio.volume>0&&(scope.audio.volume-=.1),scope.volume=scope.audio.volume},scope.volumeUp=function(){scope.audio.volume<1&&(scope.audio.volume+=.1),scope.volume=scope.audio.volume},scope.maxVolume=function(){scope.audio.muted&&(scope.audio.muted=!1),scope.audio.volume=1,scope.volume=scope.audio.volume},scope.updateVolume=function(val){scope.audio.volume=val},scope.toggleMute=function(){scope.muted=!scope.muted,scope.audio.muted=scope.muted,scope.volume=scope.muted?0:scope.audio.volume},scope.isMuted=function(){return scope.audio.muted},scope.updateLayout()}}}]).directive("volumebar",[function(){return{restrict:"E",replace:!0,scope:{value:"=",valueChange:"&"},template:"<div class='slider'><div class='slider-track'><div id='sliderValue' class='slider-value'></div></div></div>",link:function(scope,element,attr){function _calcScrubberWidth(x){var dif=x-offset;if(0>dif)dif=attr.min,scrubber.css("width","0%"),scope.value=attr.min;else if(dif>width)dif=attr.max,scrubber.css("width","100%"),scope.value=attr.max;else{var per=dif/width;scrubber.css("width",100*per+"%"),scope.value=per*attr.max}scope.valueChange({val:scope.value}),scope.$apply()}var width,offset,scrubber=angular.element(document.getElementById("sliderValue")),dragging=!1;scope.$watch("value",function(val){scrubber.css("width",val/attr.max*100+"%")}),element.on("mousedown",function(){dragging=!0,width=element[0].getBoundingClientRect().width,offset=element[0].getBoundingClientRect().left}),element.on("mouseup",function(event){dragging=!1,_calcScrubberWidth(event.pageX)}),element.on("mousemove",function(event){dragging&&_calcScrubberWidth(event.pageX)})}}}]).directive("flashplayer",["PlayerService",function(PlayerService){return{restrict:"E",replace:!0,scope:{width:"@",height:"@"},template:"<div id='flashplayer'></div>",link:function(scope){var swfVersionStr="10.2.0",xiSwfUrlStr="flash/playerProductInstall.swf",flashvars={streams:PlayerService.station()?PlayerService.station().urls:[]};console.log(PlayerService.station().urls);var params={quality:"high",wmode:"transparent",allowscriptaccess:"sameDomain"},attributes={id:"flashplayer",name:"flashplayer",align:"middle"},el=document.getElementById("flashplayer");swfobject.embedSWF("flash/Player.swf",el,scope.width,scope.height,swfVersionStr,xiSwfUrlStr,flashvars,params,attributes),swfobject.createCSS("#flashContent","display:block;text-align:left;")}}}]).directive("news",["CommunityService",function(CommunityService){return{restrict:"E",replace:!0,scope:{},template:"<div class='community news'></div>",link:function(scope,element){CommunityService.loadNews().then(function(response){var regEx=new RegExp("<body[^>]*>((.|[\n\r])*)</body>","g"),matches=response.match(regEx),content=matches[0];content=content.replace("<body>","").replace("</body>",""),element.append(content)})}}}]).directive("twitter",["CommunityService",function(){return{restrict:"E",replace:!0,scope:{},template:"<div class='community facebook'></div>",link:function(scope,element){element.append("<iframe src='http://somafm.com/app/twitter.html'></iframe>")}}}]).directive("flickr",["$rootScope","CommunityService",function($rootScope,CommunityService){return{restrict:"E",replace:!0,scope:{},template:function(){return"<div class='community flickr'><h1>Here are SomaFM listeners from around the world. Send us your pictures with your SomaFM gear to <a href='mailto:dj@somafm.com'>dj@somafm.com</a> and we'll post them on Flickr.</h1><div id='imagediv'></div><h1>More on Flickr at <a href='http://flickr.com/SomaFM' target='_blank'> www.flickr.com/SomaFM </a></h1></div>"},link:function(){var loaded=!1;loaded||CommunityService.loadFlickr().then(function(data){var htmlString="";angular.forEach(data.items,function(item){var imgSrc=item.media.m.replace("_m.jpg",".jpg");htmlString+="<div class='thumbnail with-caption'><img src='"+imgSrc+"' class='img-responsive img-rounded' /><h2>"+item.title+"</h2></div>"}),$("#imagediv").html(htmlString),loaded=!0})}}}]).directive("facebook",["$rootScope","CommunityService",function(){return{restrict:"E",replace:!0,scope:{},template:"<div class='community facebook'></div>",link:function(scope,element){element.append("<iframe src='http://somafm.com/app/facebook.html'></iframe>")}}}]),angular.module("somafmPlayerApp").controller("MainCtrl",["$scope","FavoriteSongService","PlayerService",function($scope,FavoriteSongService){$scope.showFavSongs=FavoriteSongService.isSupported(),$scope.isSelected=function(id){var el=angular.element(document.getElementById(id));return el.hasClass("selected")}}]),angular.module("somafmPlayerApp").factory("FavoriteStationService",["$cookieStore","$log","localStorageService",function($cookieStore,$log,localStorageService){var key="somafm-fav-stations",lsFn=localStorageService.isSupported?localStorageService:localStorageService.cookie,getStations=function(){var favs=lsFn.get(key)||"";return""===favs?[]:favs.split(",")},addStation=function(station){station.favorite=!0;var favs=getStations();-1==favs.indexOf(station._id)&&favs.push(station._id),lsFn.add(key,favs.join(","))},removeStation=function(station){station.favorite=!1;var favs=getStations();favs.indexOf(station._id)>-1&&favs.splice(favs.indexOf(station._id),1),lsFn.add(key,favs.join(","))},clearStations=function(){lsFn.add(key,"")},toggleStation=function(station){station.favorite=!station.favorite,station.favorite?addStation(station):removeStation(station)};return{get:getStations,add:addStation,remove:removeStation,clear:clearStations,toggle:toggleStation}}]).factory("FavoriteSongService",["$cookieStore","$log","localStorageService",function($cookieStore,$log,localStorageService){var key="somafm-fav-songs",lsFn=localStorageService,isSupported=function(){return localStorageService.isSupported},getSongs=function(){var favs=lsFn.get(key)||[];return angular.forEach(favs,function(song){song.favorite=!0}),favs},addSong=function(song){var favs=getSongs();angular.forEach(favs,function(fav){return song.artist===fav.artist&&song.title===fav.title?!1:void 0}),song.favorite=!0,favs.push(song),lsFn.add(key,favs)},removeSong=function(song){for(var favs=getSongs(),i=0;i<favs.length;i++){{favs[i]}song.artist===favs[i].artist&&song.title===favs[i].title&&(song.favorite=!1,favs.splice(i,1))}lsFn.add(key,favs)},isFav=function(song){for(var favs=getSongs(),i=0;i<favs.length;i++){{favs[i]}if(song.artist===favs[i].artist&&song.title===favs[i].title)return!0}return!1},toggleSongs=function(song){isFav(song)?removeSong(song):addSong(song)},clearSongs=function(){lsFn.add(key,"")};return{get:getSongs,add:addSong,remove:removeSong,clear:clearSongs,toggle:toggleSongs,isFav:isFav,isSupported:isSupported}}]),angular.module("somafmPlayerApp").factory("StationService",["$http","$log","$q","AppURLs","StationTransform","PlsTransform","PlaylistTransform",function($http,$log,$q,AppURLs,StationTransform,PlsTransform,PlaylistTransform){var parseData=!0,cachedData=[],getAllStations=function(){var deferred=$q.defer();if(cachedData.length>0)deferred.resolve(cachedData);
else{var opts={};parseData&&(opts.transformResponse=StationTransform),$http.get(AppURLs.allStations.url,opts).success(function(response){cachedData=response,deferred.resolve(cachedData)}).error(function(response){$log.error("Station list couldn't be loaded",response),deferred.resolve(cachedData)})}return deferred.promise},getStationDetails=function(id){var deferred=$q.defer();return getAllStations().then(function(stations){angular.forEach(stations,function(station){station._id===id&&deferred.resolve(station)})}),deferred.promise},getPls=function(station){var url=AppURLs.pls.url.replace(AppURLs.pls.key,station._id),deferred=$q.defer(),opts={};return parseData&&(opts.transformResponse=PlsTransform),$http.get(url,opts).success(function(response){deferred.resolve(response)}).error(function(response){$log.error("Station PLS couldn't be loaded",response),deferred.resolve(response)}),deferred.promise},getStationPlayList=function(station){var url=AppURLs.playList.url.replace(AppURLs.playList.key,station._id),deferred=$q.defer(),opts={};return parseData&&(opts.transformResponse=PlaylistTransform),$http.get(url,opts).success(function(response){deferred.resolve(response)}).error(function(response){$log.error("Station list couldn't be loaded",response),deferred.resolve(response)}),deferred.promise};return{getAllStations:getAllStations,getStationByID:getStationDetails,getPls:getPls,getPlayList:getStationPlayList,parseXML:function(val){parseData=val}}}]),angular.module("somafmPlayerApp").factory("PlayerService",["$log","$rootScope","$window","StationService",function($log,$rootScope,$window,StationService){var playStation=function(station){$rootScope.playingStation=null,$rootScope.showControls=!1,StationService.getPls(station).then(function(data){$rootScope.playingStation=station,$rootScope.playingStation.urls=data,$rootScope.showControls=!0})},stopStation=function(){$rootScope.playingStation=null,$rootScope.showControls=!1},getStation=function(){return $rootScope.playingStation};return{play:playStation,stop:stopStation,station:getStation,showControls:$rootScope.showControls}}]),angular.module("somafmPlayerApp").factory("CommunityService",["$http","$q","$log","AppURLs",function($http,$q,$log,AppURLs){var loadNews=function(){var deferred=$q.defer();return $http.get(AppURLs.news.url,{}).success(function(response){deferred.resolve(response)}).error(function(response){$log.error("Station list couldn't be loaded",response),deferred.resolve(null)}),deferred.promise},loadTwitter=function(){var deferred=$q.defer();return $http.get("",{}).success(function(response){deferred.resolve(response)}).error(function(response){$log.error("Station list couldn't be loaded",response),deferred.resolve(null)}),deferred.promise},loadFlickr=function(){var deferred=$q.defer();return $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?id=89961858@N00&lang=en-us&format=json&jsoncallback=?",function(data){deferred.resolve(data)}),deferred.promise},loadFacebook=function(){var deferred=$q.defer();return $http.get("",{}).success(function(response){deferred.resolve(response)}).error(function(response){$log.error("Station list couldn't be loaded",response),deferred.resolve(null)}),deferred.promise};return{loadNews:loadNews,loadTwitter:loadTwitter,loadFlickr:loadFlickr,loadFacebook:loadFacebook}}]),angular.module("somafmPlayerApp").controller("AllStationsCtrl",["$scope","$rootScope","$filter","$state","StationService","FavoriteStationService","PlayerService",function($scope,$rootScope,$filter,$state,StationService,FavoriteStationService,PlayerService){function organizeByName(src,asc){$scope.organizedStations=$filter("orderBy")(src,"title",asc)}function organizeByPopularity(src,asc){$scope.organizedStations=$filter("orderBy")(src,function(item){return parseInt(item.listeners)},asc)}function organizeByGenre(src,asc){var genres=[],stations={};angular.forEach(src,function(station){angular.forEach(station.genre.split("|"),function(genre){-1==genres.indexOf(genre)&&genres.push(genre),angular.isUndefined(stations[genre])&&(stations[genre]=[]),stations[genre].push(station)})}),$scope.organizedGenres=asc?genres.sort():genres.sort().reverse();for(var key in stations)stations.hasOwnProperty(key)&&(stations[key]=$filter("orderBy")(stations[key],"title",!1));$scope.organizedStations=stations}$scope.organizedStations=[],$scope.organizedGenres=[],$scope.stations=[],$scope.defaultOrganizeMethod="popularity";var lastOrganizeMethod="";$scope.organizeMethod="",$scope.organizeASC=!0,$scope.sortBy=function(type){switch(lastOrganizeMethod=$scope.organizeMethod,type){case"name":$scope.organizeMethod="name",$scope.organizeASC=lastOrganizeMethod!==type?!1:!$scope.organizeASC,organizeByName($scope.stations,$scope.organizeASC);break;case"popularity":$scope.organizeMethod="popularity",$scope.organizeASC=lastOrganizeMethod!==type?!0:!$scope.organizeASC,organizeByPopularity($scope.stations,$scope.organizeASC);break;case"genre":$scope.organizeMethod="genre",$scope.organizeASC=lastOrganizeMethod!==type?!0:!$scope.organizeASC,organizeByGenre($scope.stations,$scope.organizeASC)}},$scope.loadStations=function(){StationService.getAllStations().then(function(data){$scope.stations=data;var favs=FavoriteStationService.get();angular.forEach($scope.stations,function(station){station.favorite=-1!=favs.indexOf(station._id)}),$scope.sortBy($scope.defaultOrganizeMethod)})},$scope.loadStations(),$scope.playStation=function(station){PlayerService.play(station),$state.go("now-playing",{stationID:station._id})},$scope.isStationPlaying=function(station){return $rootScope.playingStation===station},$scope.stopStation=function(station){PlayerService.stop(station)},$scope.toggleFavStation=function(station){FavoriteStationService.toggle(station)}}]),angular.module("somafmPlayerApp").controller("FavStationsCtrl",["$scope","$filter","$state","StationService","FavoriteStationService","PlayerService",function($scope,$filter,$state,StationService,FavoriteStationService,PlayerService){function organizeByName(src,asc){$scope.organizedStations=$filter("orderBy")(src,"title",asc)}function organizeByPopularity(src,asc){$scope.organizedStations=$filter("orderBy")(src,function(item){return parseInt(item.listeners)},asc)}function organizeByGenre(src,asc){var genres=[],stations={};angular.forEach(src,function(station){angular.forEach(station.genre.split("|"),function(genre){-1==genres.indexOf(genre)&&genres.push(genre),angular.isUndefined(stations[genre])&&(stations[genre]=[]),stations[genre].push(station)})}),$scope.organizedGenres=asc?genres.sort():genres.sort().reverse();for(var key in stations)stations.hasOwnProperty(key)&&(stations[key]=$filter("orderBy")(stations[key],"title",!1));$scope.organizedStations=stations}$scope.organizedStations=[],$scope.organizedGenres=[],$scope.stations=[],$scope.defaultOrganizeMethod="popularity";var lastOrganizeMethod="";$scope.organizeMethod="",$scope.organizeASC=!0,$scope.sortBy=function(type){switch(lastOrganizeMethod=$scope.organizeMethod,type){case"name":$scope.organizeMethod="name",$scope.organizeASC=lastOrganizeMethod!==type?!1:!$scope.organizeASC,organizeByName($scope.stations,$scope.organizeASC);break;case"popularity":$scope.organizeMethod="popularity",$scope.organizeASC=lastOrganizeMethod!==type?!0:!$scope.organizeASC,organizeByPopularity($scope.stations,$scope.organizeASC);break;case"genre":$scope.organizeMethod="genre",$scope.organizeASC=lastOrganizeMethod!==type?!0:!$scope.organizeASC,organizeByGenre($scope.stations,$scope.organizeASC)}},$scope.removeStation=function(station){FavoriteStationService.remove(station),$scope.getStations()},$scope.isStationAFav=function(station){return-1!=$scope.stations.indexOf(station._id)},$scope.getStations=function(){var stationIds=FavoriteStationService.get();$scope.stations=[],stationIds.length>0?angular.forEach(stationIds,function(id){StationService.getStationByID(id).then(function(station){$scope.stations.push(station),$scope.sortBy($scope.defaultOrganizeMethod)})}):$scope.sortBy($scope.defaultOrganizeMethod)},$scope.getStations(),$scope.playStation=function(station){PlayerService.play(station),$state.go("now-playing",{stationID:station._id})},$scope.isStationPlaying=function(station){return $rootScope.playingStation===station},$scope.stopStation=function(station){PlayerService.stop(station)}}]),angular.module("somafmPlayerApp").controller("FavSongsCtrl",["$scope","$window","FavoriteSongService","SHOP_URI",function($scope,$window,FavoriteSongService,SHOP_URI){$scope.songs=[],$scope.refresh=function(){$scope.songs=FavoriteSongService.get()},$scope.remove=function(song){FavoriteSongService.remove(song),$scope.refresh()},$scope.shopSong=function(song){var url=SHOP_URI;url=url.replace("{ARTIST}",song.artist),url=url.replace("{SONG}",song.title),$window.open(url)},$scope.refresh()}]),angular.module("somafmPlayerApp").controller("CommunityCtrl",["$scope","AppURLs",function($scope,AppURLs){$scope.views=AppURLs.community.sections,$scope.selectedView=$scope.views[0],$scope.show=function(view){$scope.selectedView=view}}]),angular.module("somafmPlayerApp").controller("NowPlayingCtrl",["$scope","$rootScope","$timeout","$state","$stateParams","$window","PlayerService","StationService","FavoriteSongService","FavoriteStationService","SHOP_URI","POLL_INT",function($scope,$rootScope,$timeout,$state,$stateParams,$window,PlayerService,StationService,FavoriteSongService,FavoriteStationService,SHOP_URI,POLL_INT){$scope.station=null,$scope.playList=[],$scope.getPlayList=function(station){station&&StationService.getPlayList(station).then(function(playList){$scope.playList=playList,angular.forEach($scope.playList,function(song){song.favorite=FavoriteSongService.isFav(song)}),$timeout.cancel($rootScope.timer),$rootScope.timer=$timeout(function(){$scope.getPlayList($rootScope.playingStation)},POLL_INT)})},$scope.$on("$destroy",function(){$timeout.cancel($rootScope.timer)}),$scope.toggleFavStation=function(station){FavoriteStationService.toggle(station)},$scope.toggleFavSong=function(song){FavoriteSongService.toggle(song)},$scope.shopSong=function(song){var url=SHOP_URI;url=url.replace("{ARTIST}",song.artist),url=url.replace("{SONG}",song.title),$window.open(url)},$rootScope.$watch("playingStation",function(){$scope.station!==$rootScope.playingStation&&($scope.station=$rootScope.playingStation,$scope.station&&$scope.getPlayList($scope.station))}),$stateParams.stationID?(!$rootScope.playingStation||$rootScope.playingStation&&$stateParams.stationID!==$rootScope.playingStation._id)&&StationService.getStationByID($stateParams.stationID).then(function(data){PlayerService.play(data)}):$state.go("all-stations")}]);